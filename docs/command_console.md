# Command Console

The command console (`command_console_flet.py`) gives administrators a unified
workspace for broadcasting display commands, watching client activity, and
reviewing operational events. It wraps the `CommandSender` helper in a PyQt5
GUI while continuously tailing the `tspi.ops.status` heartbeat feed to populate
an operations log and the active client table.

## Interface overview

The window is split into four regions:

1. **Display controls** – quick actions for changing receiver display units,
   updating the marker highlight colour, and broadcasting session metadata
   (name plus identifier) for the active livestream. Session metadata is
   separate from timeline tags, which annotate a specific timestamp with an
   operator comment. The controls now ship with a dedicated **Tagg** button
  that freezes the current UTC timestamp, unlocks an adjacent comment field,
  and publishes the note to JetStream and TimescaleDB when you press
  **Save/Send**. Tags posted during live operations appear instantly across
  connected consoles and receivers, while datastore playback surfaces the
  annotation when the playhead reaches the original timestamp so the comment
  aligns with the recorded event.
   The controls reuse the same headless automation flags so scripted workflows
   can reuse the UI entry point.
2. **Group replay** – launch or stop datastore-backed group replays by first
   choosing a datastore recording (by metadata name or capture date), then
   positioning the replay slider or picking a named tag inside that recording.
   The console generates a replay identifier and display label automatically
   before publishing the control message to the selected telemetry stream. The
   console tracks the active replay channel so the operator can stop it later or
   broadcast a replacement.
3. **Operations log** – a scrolling, read-only text panel that records notable
   events and confirmations for every broadcast command. Examples include:
   - `Units set to metric`
   - `Marker color set to #00ff00`
   - `Session metadata set to Falcon Lead (42)`
   - `New client connected from IP 203.0.113.12: alpha-01`
   - `Client bravo-06 started replay on replay.20250215T214500Z`
   - `Client charlie-03 resumed live view`
4. **Active client table** – a live roster of connected receivers showing the
   client identifier, streaming channel, streaming status, connection time,
   last heartbeat, operator login, and the latest ping measurement.

The UI enforces a 500-entry cap on the log to prevent unbounded growth while
keeping recent activity at hand. All timestamps are displayed in UTC using the
`YYYY-MM-DD HH:MM:SSZ` format to align with the rest of the toolkit.

## Supported commands

Three command families ship with the console today. Display commands are
encoded as CBOR payloads and published beneath the `tspi.cmd.display.*`
hierarchy, while replay control messages are delivered on `tspi.ops.ctrl` so
all receivers can co-ordinate the transition into or out of a datastore replay.

| Command | Subject | Purpose |
| --- | --- | --- |
| `display.units` | `tspi.cmd.display.units` | Switch receivers between `metric` and `imperial` display units. |
| `display.marker_color` | `tspi.cmd.display.marker_color` | Update the highlight colour receivers use for tracked aircraft markers. |
| `display.session_metadata` | `tspi.cmd.display.session_metadata` | Broadcast operator-selected session metadata (name and identifier) so receivers can surface the current livestream context. |
| `GroupReplayStart` | `tspi.ops.ctrl` | Start a datastore-backed group replay for all clients using the supplied datastore identifier or tag. |
| `GroupReplayStop` | `tspi.ops.ctrl` | Stop the active group replay (either the most recent one or a specific channel ID). |

The GUI offers curated colour presets (green, red, blue, magenta, yellow) while
the CLI accepts any CSS-compatible colour string or hex value.

### Launching a group replay from the GUI

1. Pick the datastore recording from the **Datastore Recording** dropdown. Each
   entry shows the friendly metadata name and the UTC capture time so you can
   distinguish between datachunks quickly.
2. Select a replay startpoint:
   - Drag the **Start (UTC)** slider to the desired timestamp within the
     recording. The label to the right updates with the precise UTC value.
   - Or pick a named tag from the **Named Tags** dropdown. Tags are generated by
     clients or operators and automatically align the slider to the tagged
     timestamp.
   The console fills the **Replay Identifier** field with a slug that combines
   the recording and startpoint so downstream systems receive a unique channel
   name.
3. Confirm the **Telemetry Stream** matches the JetStream stream that stores
   the archived telemetry (defaults to the `--js-stream` CLI argument).
4. Press **Play** to broadcast the `GroupReplayStart` payload. Playback
   continues until the datastore chunk ends or the administrator presses
   **Stop Replay**.

The **Active Channel** field updates with the generated replay channel ID
(for example, `replay.20250928T110000Z` or `replay.intercept-window-3`). Press
**Stop Replay** at any time to emit the matching `GroupReplayStop` control
message and return clients to the livestream.

## Client heartbeats and events

The console expects clients to publish heartbeats to `tspi.ops.status`. Each
message is stored in the `TSPI_OPS` JetStream stream (configurable via
`--ops-stream`) and should include the following fields:

| Field | Description |
| --- | --- |
| `client_id` | Stable identifier for the receiver. |
| `state` | Playback state (`FOLLOWING_LIVESTREAM`, `FOLLOWING_GROUP_REPLAY`, `FOLLOWING_PRIVATE_REPLAY`, `LIVE_OVERRIDE`). |
| `channel_id` | Human-readable channel identifier such as `livestream` or `replay.20250215T214500Z`. |
| `subject` | Underlying JetStream delivery subject for the client. |
| `override` | Boolean flag indicating a temporary live override during a group replay. |
| `ts` | ISO-8601 timestamp (UTC preferred) for the heartbeat. |
| `operator` | (Optional) Operator login currently controlling the client. |
| `source_ip` | (Optional) Remote IP address observed by the server. |
| `ping_ms` | (Optional) Last round-trip measurement in milliseconds. |

The console derives log messages whenever a client connects, starts a replay,
or returns to live view. Additional fields are preserved in the client table so
operators can correlate activity with specific workstations or accounts.

## Running the console

### GUI mode (default)

```bash
python command_console_flet.py --nats-server nats://127.0.0.1:4222 \
    --js-stream TSPI --ops-stream TSPI_OPS --stream-prefix tspi
```

* The console provisions the telemetry stream and operations stream if they do
  not already exist.
* Use the **Display Units** dropdown or **Marker Colour** palette to send a
  command. Sent commands update the status banner and append an entry to the log.
* Press **Tagg** to capture the current UTC timestamp, type a comment, and press
  **Save/Send**. The console publishes the resulting tag immediately so live
  viewers see it right away, and the datastore replay engine delays the
  annotation until playback reaches the captured timestamp.
* Heartbeats arriving on `tspi.ops.status` populate both the log and the active
  client table.

### Headless mode

```bash
python command_console_flet.py --headless --nats-server nats://127.0.0.1:4222 \
    --units metric --marker-color "#ff8800" --session-name "Falcon Lead" --session-id 42 \
    --group-replay-id "Intercept Window 3"
```

* Headless mode skips the GUI and requires one or more of `--units`,
  `--marker-color`, the session metadata pair `--session-name`/`--session-id`,
  or the replay controls `--group-replay-id`/`--stop-group-replay`.
* Session metadata broadcasts are treated as global display metadata just like
  the unit change command so every receiver can surface the current mission or
  callsign context. Event tags remain available separately for annotating a
  specific time with an operator comment.
* `--group-replay-id` publishes a `GroupReplayStart` command to
  `tspi.ops.ctrl` using the supplied datastore identifier, comment tag, or
  timestamp. Playback runs until the underlying data chunk completes or the
  operator issues `--stop-group-replay`.
* `--stop-group-replay` stops the most recent replay launched by the session or
  a specific channel ID when provided.
* The script exits with an error if no command flags are provided.
* When no NATS servers are supplied, the console falls back to the in-memory
  broker used by the receiver tests. The headless command publisher remains
  available, but the client table stays empty without external heartbeats.

## Troubleshooting

* Ensure the receiver applications publish heartbeats to `tspi.ops.status` and
  that the console can read from the `TSPI_OPS` stream.
* If publishing fails, the console surfaces the JetStream error in the status
  banner (GUI) or raises an exception (headless).
* The `--sender-id` flag lets you customise the `sender` metadata stored with
  each command payload for auditing or logging pipelines.
* Use `--status-subject` if your deployment stores heartbeats on a different
  subject name.
